name: Port - Create Microservice

on:
  workflow_dispatch:
    inputs:
      service_name:
        description: 'Name of the microservice'
        required: true
        type: string
      owner:
        description: 'Owner of the service'
        required: false
        default: 'crh225'
        type: string
      description:
        description: 'Description of the service'
        required: false
        default: 'A new microservice'
        type: string
      port_run_id:
        description: 'Port action run ID for status updates'
        required: true
        type: string

jobs:
  create-microservice:
    runs-on: ubuntu-latest
    steps:
      - name: Inform Port - Starting
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.port.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "RUNNING"
          logMessage: "Starting microservice creation for ${{ inputs.service_name }}"

      - name: Checkout
        uses: actions/checkout@v4

      - name: Create GitHub Repository
        id: create-repo
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Create repo from template
          gh repo create crh225/${{ inputs.service_name }} \
            --template crh225/microservice-node-template \
            --public \
            --description "${{ inputs.description }}"

          echo "repo_url=https://github.com/crh225/${{ inputs.service_name }}" >> $GITHUB_OUTPUT

      - name: Wait for repo to be ready
        run: sleep 10

      - name: Create ArgoCD Application Manifest
        run: |
          cat > argocd-app.yaml << 'EOF'
          apiVersion: argoproj.io/v1alpha1
          kind: Application
          metadata:
            name: ${{ inputs.service_name }}
            namespace: argocd
            labels:
              app.kubernetes.io/part-of: platform
              app.kubernetes.io/component: microservice
            finalizers:
              - resources-finalizer.argocd.argoproj.io
          spec:
            project: default
            source:
              repoURL: https://github.com/crh225/${{ inputs.service_name }}.git
              targetRevision: main
              path: helm
              helm:
                valueFiles:
                  - values.yaml
                parameters:
                  - name: image.repository
                    value: ghcr.io/crh225/${{ inputs.service_name }}
                  - name: image.tag
                    value: latest
            destination:
              server: https://kubernetes.default.svc
              namespace: dev
            syncPolicy:
              automated:
                prune: true
                selfHeal: true
              syncOptions:
                - CreateNamespace=true
              retry:
                limit: 5
                backoff:
                  duration: 5s
                  factor: 2
                  maxDuration: 3m
          EOF

      - name: Commit ArgoCD Manifest to GitOps Repo
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # Clone the GitOps repo
          git clone https://x-access-token:${GH_TOKEN}@github.com/crh225/ARMServicePortal.git gitops
          cd gitops

          # Copy the manifest
          mkdir -p infra/argocd/microservices
          cp ../argocd-app.yaml infra/argocd/microservices/${{ inputs.service_name }}.yaml

          # Commit and push
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add .
          git commit -m "feat: add ArgoCD manifest for ${{ inputs.service_name }}"
          git push

      - name: Inform Port - Success
        if: success()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.port.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "SUCCESS"
          logMessage: |
            Microservice ${{ inputs.service_name }} created successfully!
            - GitHub Repo: https://github.com/crh225/${{ inputs.service_name }}
            - ArgoCD will sync automatically
          link: '["https://github.com/crh225/${{ inputs.service_name }}"]'

      - name: Inform Port - Failure
        if: failure()
        uses: port-labs/port-github-action@v1
        with:
          clientId: ${{ secrets.PORT_CLIENT_ID }}
          clientSecret: ${{ secrets.PORT_CLIENT_SECRET }}
          baseUrl: https://api.port.io
          operation: PATCH_RUN
          runId: ${{ inputs.port_run_id }}
          status: "FAILURE"
          logMessage: "Failed to create microservice ${{ inputs.service_name }}"
