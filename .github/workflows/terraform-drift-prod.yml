name: Terraform Drift Detection - Production

on:
  schedule:
    # Run every 2 hours (most frequent for production)
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  drift-detection:
    runs-on: ubuntu-latest

    env:
      ARM_CLIENT_ID:       ${{ secrets.AZURE_CLIENT_ID }}
      ARM_CLIENT_SECRET:   ${{ secrets.AZURE_CLIENT_SECRET }}
      ARM_TENANT_ID:       ${{ secrets.AZURE_TENANT_ID }}
      ARM_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    defaults:
      run:
        working-directory: infra/environments/prod

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5

      - name: Terraform Init
        run: terraform init -input=false

      - name: Terraform Plan (detect drift)
        id: drift_plan
        continue-on-error: true
        env:
          TF_VAR_github_infra_owner:            ${{ secrets.GH_INFRA_OWNER }}
          TF_VAR_github_infra_repo:             ${{ secrets.GH_INFRA_REPO }}
          TF_VAR_github_app_id:                 ${{ secrets.GH_APP_ID }}
          TF_VAR_github_installation_id:        ${{ secrets.GH_INSTALLATION_ID }}
          TF_VAR_github_app_private_key_base64: ${{ secrets.GH_APP_PRIVATE_KEY_BASE64 }}
        run: |
          terraform plan -detailed-exitcode -input=false -no-color > drift-plan.txt 2>&1
          echo "exit_code=$?" >> $GITHUB_OUTPUT

      - name: Create drift issue if detected
        if: steps.drift_plan.outputs.exit_code == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const driftPlan = fs.readFileSync('infra/environments/prod/drift-plan.txt', 'utf8');

            const title = 'üî¥ CRITICAL: Terraform Drift Detected in PRODUCTION';
            const body = [
              '**Environment:** üî¥ **PRODUCTION**',
              `**Detected:** ${new Date().toISOString()}`,
              '',
              '‚ö†Ô∏è **CRITICAL**: Configuration drift detected in production environment!',
              '',
              'This requires immediate attention. Production infrastructure state',
              'differs from the Terraform code, which could lead to:',
              '- Unexpected behavior during future deployments',
              '- Security vulnerabilities',
              '- Compliance violations',
              '',
              '<details><summary>View Drift Plan</summary>',
              '',
              '```',
              driftPlan.substring(0, 60000),
              '```',
              '',
              '</details>',
              '',
              '**IMMEDIATE ACTION REQUIRED:**',
              '1. **DO NOT IGNORE** - Review the drift plan immediately',
              '2. Identify who made manual changes to production',
              '3. Assess security and compliance impact',
              '4. Create incident ticket if necessary',
              '5. Update Terraform code or remediate infrastructure',
              '6. Document the incident and remediation steps',
              '',
              `**Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
            ].join('\n');

            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'drift-detection,environment:prod'
            });

            if (issues.length > 0) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `üî¥ **CRITICAL: Drift STILL detected as of ${new Date().toISOString()}**\n\nThis issue has been open and drift persists!\n\nSee latest workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ['drift-detection', 'environment:prod', 'priority:critical', 'incident']
              });
            }
