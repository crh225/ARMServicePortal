name: "Azure Function: Deploy GitHub Webhook Relay"

on:
  push:
    branches: [main]
    paths:
      - "functions/github-webhook-relay/**"
  workflow_dispatch:
    inputs:
      environment:
        description: "Deployment environment"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
          - prod

permissions:
  id-token: write
  contents: read

env:
  # Function app created by Terraform: func-{project_name}-{env}-{random}
  # The suffix comes from Terraform's random_string resource
  AZURE_FUNCTIONAPP_NAME: "func-fnnotification-dev-a2c8"
  AZURE_FUNCTIONAPP_PACKAGE_PATH: "functions/github-webhook-relay"
  AZURE_RESOURCE_GROUP: "rg-testpr3-dev-rg"
  NODE_VERSION: "20.x"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: "${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/package-lock.json"

      - name: Install dependencies
        working-directory: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
        run: npm ci

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Check if Function App exists
        id: check_app
        run: |
          EXISTS=$(az functionapp show \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query name -o tsv 2>/dev/null || echo "")

          if [ -z "$EXISTS" ]; then
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Function App does not exist. Run terraform-dev workflow first to create it."
          else
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Function App exists: $EXISTS"
          fi

      - name: Get Function App settings from Key Vault
        if: steps.check_app.outputs.exists == 'true'
        id: keyvault
        run: |
          # Fetch secrets from Key Vault
          RABBITMQ_URL=$(az keyvault secret show --vault-name akvnotintf1 --name rabbitmq-url --query value -o tsv 2>/dev/null || echo "")
          GH_WEBHOOK_SECRET=$(az keyvault secret show --vault-name akvnotintf1 --name github-webhook-secret --query value -o tsv 2>/dev/null || echo "")

          # Set outputs (masked)
          echo "::add-mask::$RABBITMQ_URL"
          echo "::add-mask::$GH_WEBHOOK_SECRET"
          echo "rabbitmq_url=$RABBITMQ_URL" >> $GITHUB_OUTPUT
          echo "gh_webhook_secret=$GH_WEBHOOK_SECRET" >> $GITHUB_OUTPUT

      - name: Configure Function App settings
        if: steps.check_app.outputs.exists == 'true'
        run: |
          echo "Configuring Function App settings..."

          az functionapp config appsettings set \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --settings \
              "RABBITMQ_URL=${{ steps.keyvault.outputs.rabbitmq_url }}" \
              "GH_WEBHOOK_SECRET=${{ steps.keyvault.outputs.gh_webhook_secret }}" \
              "FUNCTIONS_WORKER_RUNTIME=node" \
              "NODE_ENV=production"

          echo "Function App settings configured"

      - name: Deploy to Azure Functions
        if: steps.check_app.outputs.exists == 'true'
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME }}
          package: ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}
          respect-funcignore: true

      - name: Verify deployment
        if: steps.check_app.outputs.exists == 'true'
        run: |
          echo "Verifying deployment..."

          FUNCTION_URL=$(az functionapp show \
            --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --query defaultHostName -o tsv)

          echo "Function App URL: https://$FUNCTION_URL"
          echo ""

          # Test health endpoint
          echo "Testing health endpoint..."
          curl -s "https://$FUNCTION_URL/api/health" | jq . || echo "Health check returned non-JSON response"

          echo ""
          echo "Deployment complete!"
          echo ""
          echo "GitHub Webhook URL: https://$FUNCTION_URL/api/webhooks/github"
          echo ""
          echo "Configure this URL in your GitHub repository webhooks:"
          echo "  1. Go to GitHub repo > Settings > Webhooks > Add webhook"
          echo "  2. Payload URL: https://$FUNCTION_URL/api/webhooks/github"
          echo "  3. Content type: application/json"
          echo "  4. Secret: (same as github-webhook-secret in Key Vault)"
          echo "  5. Events: Select the events you want to receive"

      - name: Function App not found
        if: steps.check_app.outputs.exists == 'false'
        run: |
          echo "::error::Function App '${{ env.AZURE_FUNCTIONAPP_NAME }}' does not exist in resource group '${{ env.AZURE_RESOURCE_GROUP }}'"
          echo ""
          echo "Please run the terraform-dev workflow first to create the Function App infrastructure."
          echo "The Azure Function blueprint (azure-function) in ARM Portal creates:"
          echo "  - Storage Account"
          echo "  - App Service Plan"
          echo "  - Application Insights"
          echo "  - Linux Function App"
          echo ""
          echo "After Terraform creates the Function App, this workflow will deploy the code."
          exit 1
