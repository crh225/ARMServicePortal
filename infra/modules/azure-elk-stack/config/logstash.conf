input {
  # Beats input for receiving logs from Node.js applications
  beats {
    port => 5044
    host => "0.0.0.0"
  }

  # TCP input for Winston or other TCP-based loggers
  tcp {
    port => 5000
    codec => json
  }

  # HTTP input for HTTP-based logging
  http {
    port => 8080
    codec => json
  }
}

filter {
  # Parse JSON logs
  if [message] =~ /^\{.*\}$/ {
    json {
      source => "message"
    }
  }

  # Add useful fields
  mutate {
    add_field => {
      "[@@metadata][target_index]" => "nodejs-logs-%%{+YYYY.MM.dd}"
    }
  }

  # Parse timestamp if present
  if [timestamp] {
    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }

  # Categorize log levels
  if [level] {
    mutate {
      lowercase => [ "level" ]
    }
  }
}

output {
  # Output to Elasticsearch
  elasticsearch {
    hosts => ["${elasticsearch_host}:${elasticsearch_port}"]
    index => "%%{[@@metadata][target_index]}"

    # Create index template for better field mappings
    manage_template => true
    template_name => "nodejs-logs"
    template_pattern => "nodejs-logs-*"
  }

  # Debug output (can be removed in production)
  stdout {
    codec => rubydebug
  }
}
