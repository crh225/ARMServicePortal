# Enable Istio sidecar injection for namespaces
# Pods in these namespaces will automatically get Envoy proxy sidecars

---
# Backend namespace - enable injection
apiVersion: v1
kind: Namespace
metadata:
  name: armportal-backend
  labels:
    istio-injection: enabled
    # Keep existing labels
    argocd.argoproj.io/managed-by: argocd

---
# RabbitMQ namespace - enable injection
# Note: This needs to be applied BEFORE Crossplane creates the namespace
# Or update the Crossplane composition to include this label
apiVersion: v1
kind: Namespace
metadata:
  name: xp-rabbitmq-dev
  labels:
    istio-injection: enabled

---
# Redis namespace - enable injection
apiVersion: v1
kind: Namespace
metadata:
  name: xp-redis-dev
  labels:
    istio-injection: enabled

---
# You can also use a Sidecar resource to fine-tune what the proxy sees
apiVersion: networking.istio.io/v1beta1
kind: Sidecar
metadata:
  name: default
  namespace: armportal-backend
spec:
  egress:
    - hosts:
        # Only allow egress to these namespaces (security)
        - "istio-system/*"
        - "xp-rabbitmq-dev/*"
        - "xp-redis-dev/*"
        # Allow external (for Azure APIs, GitHub, etc)
        - "~/*"  # Wildcard for external services
