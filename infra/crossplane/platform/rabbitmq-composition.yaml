---
# RabbitMQ Composition (Crossplane v2 Pipeline Mode)
# Implements the XRD by creating: Namespace, Secret, PVC, Deployment, Service, Ingress
# Management UI is exposed at {name}.pr.chrishouse.io using the wildcard cert
apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: rabbitmq
  labels:
    crossplane.io/xrd: rabbitmq.platform.chrishouse.io
    provider: kubernetes
spec:
  compositeTypeRef:
    apiVersion: platform.chrishouse.io/v1alpha1
    kind: RabbitMQ

  writeConnectionSecretsToNamespace: crossplane-system

  mode: Pipeline
  pipeline:
    - step: patch-and-transform
      functionRef:
        name: function-patch-and-transform
      input:
        apiVersion: pt.fn.crossplane.io/v1beta1
        kind: Resources

        patchSets:
          # Common labels applied to all resources
          - name: common-labels
            patches:
              - type: FromCompositeFieldPath
                fromFieldPath: spec.parameters.name
                toFieldPath: metadata.labels["app.kubernetes.io/name"]
              - type: FromCompositeFieldPath
                fromFieldPath: spec.parameters.environment
                toFieldPath: metadata.labels["app.kubernetes.io/environment"]
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: metadata.labels["app.kubernetes.io/instance"]

          # Namespace patch - used by all namespaced resources
          - name: namespace-patch
            patches:
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: spec.forProvider.manifest.metadata.namespace

        resources:
          # ============================================================
          # 1. NAMESPACE
          # ============================================================
          - name: namespace
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: Namespace
                    metadata:
                      name: ""
                      labels:
                        app.kubernetes.io/managed-by: crossplane
                        platform.chrishouse.io/type: rabbitmq
            patches:
              - type: PatchSet
                patchSetName: common-labels
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "namespace-%s-%s"
                toFieldPath: metadata.name

          # ============================================================
          # 2. RABBITMQ CREDENTIALS SECRET
          # ============================================================
          - name: rabbitmq-secret
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: Secret
                    metadata:
                      name: ""
                      labels:
                        app.kubernetes.io/component: rabbitmq
                    type: Opaque
                    stringData:
                      username: "admin"
                      # In production, this should use a random password generator
                      password: "rabbitmq-secret-123"
            patches:
              - type: PatchSet
                patchSetName: common-labels
              - type: PatchSet
                patchSetName: namespace-patch
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq-credentials"
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "rabbitmq-secret-%s-%s"
                toFieldPath: metadata.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.parameters.adminUsername
                toFieldPath: spec.forProvider.manifest.stringData.username

          # ============================================================
          # 3. PVC FOR RABBITMQ DATA
          # ============================================================
          - name: rabbitmq-pvc
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: PersistentVolumeClaim
                    metadata:
                      name: ""
                      labels:
                        app.kubernetes.io/component: rabbitmq
                    spec:
                      accessModes:
                        - ReadWriteOnce
                      resources:
                        requests:
                          storage: "5Gi"
                      storageClassName: managed-csi
            patches:
              - type: PatchSet
                patchSetName: common-labels
              - type: PatchSet
                patchSetName: namespace-patch
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq-data"
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "rabbitmq-pvc-%s-%s"
                toFieldPath: metadata.name
              - type: FromCompositeFieldPath
                fromFieldPath: spec.parameters.storageGB
                toFieldPath: spec.forProvider.manifest.spec.resources.requests.storage
                transforms:
                  - type: convert
                    convert:
                      toType: int64
                  - type: string
                    string:
                      type: Format
                      fmt: "%dGi"

          # ============================================================
          # 4. RABBITMQ DEPLOYMENT
          # ============================================================
          - name: rabbitmq-deployment
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: apps/v1
                    kind: Deployment
                    metadata:
                      name: ""
                      labels:
                        app.kubernetes.io/component: rabbitmq
                    spec:
                      replicas: 1
                      selector:
                        matchLabels:
                          app.kubernetes.io/component: rabbitmq
                      strategy:
                        type: Recreate
                      template:
                        metadata:
                          labels:
                            app.kubernetes.io/component: rabbitmq
                        spec:
                          containers:
                            - name: rabbitmq
                              image: rabbitmq:3.13-management-alpine
                              ports:
                                - containerPort: 5672
                                  name: amqp
                                - containerPort: 15672
                                  name: management
                              env:
                                - name: RABBITMQ_DEFAULT_USER
                                  valueFrom:
                                    secretKeyRef:
                                      name: ""
                                      key: username
                                - name: RABBITMQ_DEFAULT_PASS
                                  valueFrom:
                                    secretKeyRef:
                                      name: ""
                                      key: password
                              volumeMounts:
                                - name: rabbitmq-data
                                  mountPath: /var/lib/rabbitmq
                              resources:
                                requests:
                                  cpu: "200m"
                                  memory: "256Mi"
                                limits:
                                  cpu: "1000m"
                                  memory: "512Mi"
                              readinessProbe:
                                tcpSocket:
                                  port: 5672
                                initialDelaySeconds: 10
                                periodSeconds: 10
                              livenessProbe:
                                tcpSocket:
                                  port: 5672
                                initialDelaySeconds: 30
                                periodSeconds: 30
                          volumes:
                            - name: rabbitmq-data
                              persistentVolumeClaim:
                                claimName: ""
            patches:
              - type: PatchSet
                patchSetName: common-labels
              - type: PatchSet
                patchSetName: namespace-patch
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq"
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "rabbitmq-deployment-%s-%s"
                toFieldPath: metadata.name
              # Image version
              - type: FromCompositeFieldPath
                fromFieldPath: spec.parameters.rabbitmqVersion
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].image
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "rabbitmq:%s-management-alpine"
              # Memory limits
              - type: FromCompositeFieldPath
                fromFieldPath: spec.parameters.memoryLimitMB
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].resources.limits.memory
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%dMi"
              # Secret reference for username
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq-credentials"
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[0].valueFrom.secretKeyRef.name
              # Secret reference for password
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq-credentials"
                toFieldPath: spec.forProvider.manifest.spec.template.spec.containers[0].env[1].valueFrom.secretKeyRef.name
              # PVC reference
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq-data"
                toFieldPath: spec.forProvider.manifest.spec.template.spec.volumes[0].persistentVolumeClaim.claimName
              # Instance labels for selector
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: spec.forProvider.manifest.spec.selector.matchLabels["app.kubernetes.io/instance"]
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: spec.forProvider.manifest.spec.template.metadata.labels["app.kubernetes.io/instance"]

          # ============================================================
          # 5. RABBITMQ SERVICE
          # ============================================================
          - name: rabbitmq-service
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: Service
                    metadata:
                      name: ""
                      labels:
                        app.kubernetes.io/component: rabbitmq
                    spec:
                      type: ClusterIP
                      ports:
                        - port: 5672
                          targetPort: 5672
                          protocol: TCP
                          name: amqp
                        - port: 15672
                          targetPort: 15672
                          protocol: TCP
                          name: management
                      selector:
                        app.kubernetes.io/component: rabbitmq
            patches:
              - type: PatchSet
                patchSetName: common-labels
              - type: PatchSet
                patchSetName: namespace-patch
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq"
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "rabbitmq-service-%s-%s"
                toFieldPath: metadata.name
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s"
                toFieldPath: spec.forProvider.manifest.spec.selector["app.kubernetes.io/instance"]

          # ============================================================
          # 6. COPY WILDCARD TLS SECRET TO NAMESPACE
          # ============================================================
          - name: tls-secret-copy
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: v1
                    kind: Secret
                    metadata:
                      name: pr-wildcard-tls
                      labels:
                        app.kubernetes.io/component: tls
                    type: kubernetes.io/tls
                    data:
                      # These will be populated by the secrets-store-csi-driver sync
                      # or copied from cert-manager namespace
                      tls.crt: ""
                      tls.key: ""
                references:
                  - patchesFrom:
                      apiVersion: v1
                      kind: Secret
                      name: pr-wildcard-tls
                      namespace: cert-manager
                      fieldPath: data
                    toFieldPath: data
            patches:
              - type: PatchSet
                patchSetName: common-labels
              - type: PatchSet
                patchSetName: namespace-patch
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "tls-secret-%s-%s"
                toFieldPath: metadata.name

          # ============================================================
          # 7. INGRESS FOR MANAGEMENT UI
          # ============================================================
          - name: rabbitmq-ingress
            base:
              apiVersion: kubernetes.crossplane.io/v1alpha2
              kind: Object
              spec:
                forProvider:
                  manifest:
                    apiVersion: networking.k8s.io/v1
                    kind: Ingress
                    metadata:
                      name: ""
                      labels:
                        app.kubernetes.io/component: ingress
                      annotations:
                        nginx.ingress.kubernetes.io/backend-protocol: HTTP
                    spec:
                      ingressClassName: nginx
                      tls:
                        - hosts:
                            - ""
                          secretName: pr-wildcard-tls
                      rules:
                        - host: ""
                          http:
                            paths:
                              - path: /
                                pathType: Prefix
                                backend:
                                  service:
                                    name: ""
                                    port:
                                      number: 15672
            patches:
              - type: PatchSet
                patchSetName: common-labels
              - type: PatchSet
                patchSetName: namespace-patch
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq-ingress"
                toFieldPath: spec.forProvider.manifest.metadata.name
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "rabbitmq-ingress-%s-%s"
                toFieldPath: metadata.name
              # Hostname: {name}.pr.chrishouse.io
              - type: FromCompositeFieldPath
                fromFieldPath: spec.parameters.name
                toFieldPath: spec.forProvider.manifest.spec.rules[0].host
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s.pr.chrishouse.io"
              - type: FromCompositeFieldPath
                fromFieldPath: spec.parameters.name
                toFieldPath: spec.forProvider.manifest.spec.tls[0].hosts[0]
                transforms:
                  - type: string
                    string:
                      type: Format
                      fmt: "%s.pr.chrishouse.io"
              # Service backend
              - type: CombineFromComposite
                combine:
                  variables:
                    - fromFieldPath: spec.parameters.name
                    - fromFieldPath: spec.parameters.environment
                  strategy: string
                  string:
                    fmt: "%s-%s-rabbitmq"
                toFieldPath: spec.forProvider.manifest.spec.rules[0].http.paths[0].backend.service.name
