---
# ApplicationEnvironment XRD (CompositeResourceDefinition)
# Defines a complete application stack: frontend + backend + PostgreSQL
# This is the "API" that platform consumers use to request environments
apiVersion: apiextensions.crossplane.io/v1
kind: CompositeResourceDefinition
metadata:
  name: applicationenvironments.platform.chrishouse.io
spec:
  group: platform.chrishouse.io
  names:
    kind: ApplicationEnvironment
    plural: applicationenvironments
    shortNames:
      - appenv
      - ae
  claimNames:
    kind: ApplicationEnvironmentClaim
    plural: applicationenvironmentclaims
  connectionSecretKeys:
    - database-host
    - database-port
    - database-username
    - database-password
    - database-name
  versions:
    - name: v1alpha1
      served: true
      referenceable: true
      schema:
        openAPIV3Schema:
          type: object
          properties:
            spec:
              type: object
              required:
                - parameters
              properties:
                parameters:
                  type: object
                  required:
                    - appName
                    - environment
                    - frontend
                    - backend
                    - database
                    - ingress
                  properties:
                    appName:
                      type: string
                      description: "Application name (used in resource naming)"
                      pattern: "^[a-z][a-z0-9-]{1,20}$"
                    environment:
                      type: string
                      description: "Environment name (dev, staging, prod)"
                      enum:
                        - dev
                        - staging
                        - prod
                    frontend:
                      type: object
                      required:
                        - imageRepo
                        - tag
                      properties:
                        imageRepo:
                          type: string
                          description: "Container registry path for frontend image"
                        tag:
                          type: string
                          description: "Image tag for frontend"
                          default: "latest"
                        replicas:
                          type: integer
                          description: "Number of frontend replicas"
                          default: 2
                          minimum: 1
                          maximum: 10
                        resources:
                          type: object
                          properties:
                            cpu:
                              type: string
                              default: "100m"
                            memory:
                              type: string
                              default: "128Mi"
                        port:
                          type: integer
                          description: "Container port for frontend"
                          default: 80
                    backend:
                      type: object
                      required:
                        - imageRepo
                        - tag
                      properties:
                        imageRepo:
                          type: string
                          description: "Container registry path for backend image"
                        tag:
                          type: string
                          description: "Image tag for backend"
                          default: "latest"
                        replicas:
                          type: integer
                          description: "Number of backend replicas"
                          default: 2
                          minimum: 1
                          maximum: 10
                        resources:
                          type: object
                          properties:
                            cpu:
                              type: string
                              default: "200m"
                            memory:
                              type: string
                              default: "256Mi"
                        port:
                          type: integer
                          description: "Container port for backend"
                          default: 3000
                    database:
                      type: object
                      required:
                        - storageGB
                      properties:
                        storageGB:
                          type: integer
                          description: "Database storage size in GB"
                          minimum: 5
                          maximum: 1000
                          default: 10
                        version:
                          type: string
                          description: "PostgreSQL version"
                          enum:
                            - "14"
                            - "15"
                            - "16"
                          default: "16"
                    ingress:
                      type: object
                      required:
                        - host
                      properties:
                        host:
                          type: string
                          description: "Ingress hostname"
                        tlsEnabled:
                          type: boolean
                          description: "Enable TLS via cert-manager"
                          default: true
                        clusterIssuer:
                          type: string
                          description: "cert-manager ClusterIssuer name"
                          default: "letsencrypt-prod"
                        annotations:
                          type: object
                          additionalProperties:
                            type: string
                          description: "Additional ingress annotations"
            status:
              type: object
              properties:
                phase:
                  type: string
                  description: "Current phase of the application environment"
                namespaceRef:
                  type: string
                  description: "Reference to the created namespace"
                frontendEndpoint:
                  type: string
                  description: "URL to access the frontend"
                backendEndpoint:
                  type: string
                  description: "Internal backend service endpoint"
                databaseEndpoint:
                  type: string
                  description: "Database connection endpoint"
                conditions:
                  type: array
                  items:
                    type: object
                    properties:
                      type:
                        type: string
                      status:
                        type: string
                      reason:
                        type: string
                      message:
                        type: string
                      lastTransitionTime:
                        type: string
      additionalPrinterColumns:
        - name: App
          type: string
          jsonPath: ".spec.parameters.appName"
        - name: Environment
          type: string
          jsonPath: ".spec.parameters.environment"
        - name: Host
          type: string
          jsonPath: ".spec.parameters.ingress.host"
        - name: Ready
          type: string
          jsonPath: ".status.conditions[?(@.type=='Ready')].status"
        - name: Age
          type: date
          jsonPath: ".metadata.creationTimestamp"
