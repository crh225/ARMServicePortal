# DestinationRules define traffic policies for services
# These configure how the Envoy proxy connects to upstream services

---
# RabbitMQ destination rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: rabbitmq
  namespace: rabbit-xp1-dev  # Update to match your actual namespace
spec:
  host: "*.rabbit-xp1-dev.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL  # Use Istio's auto-generated mTLS certs

    # Connection pool settings
    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 10s
      http:
        h2UpgradePolicy: DO_NOT_UPGRADE  # RabbitMQ uses raw TCP

    # Circuit breaker / outlier detection
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 30s
      maxEjectionPercent: 50

---
# Redis destination rule
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: redis
  namespace: redis-xp1-dev  # Update to match your actual namespace
spec:
  host: "*.redis-xp1-dev.svc.cluster.local"
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      tcp:
        maxConnections: 100
        connectTimeout: 5s

    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 30s

---
# Backend destination rule (for internal traffic)
apiVersion: networking.istio.io/v1beta1
kind: DestinationRule
metadata:
  name: armportal-backend
  namespace: armportal-backend
spec:
  host: armportal-backend.armportal-backend.svc.cluster.local
  trafficPolicy:
    tls:
      mode: ISTIO_MUTUAL

    connectionPool:
      http:
        h2UpgradePolicy: UPGRADE
        maxRequestsPerConnection: 100

    # Load balancing
    loadBalancer:
      simple: ROUND_ROBIN

    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 60s
