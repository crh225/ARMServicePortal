# Azure Key Vault SecretProviderClass for portal-api secrets
# Uses CSI Secret Store Driver to mount secrets from Azure Key Vault
---
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: azure-backend-secrets
  namespace: portal-api
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "true"
    userAssignedIdentityID: "1709da22-9c4a-4f71-b984-c77565390843"
    keyvaultName: "akvnotintf1"
    tenantId: "354b7ce2-bca3-4af5-b19a-e05a09b68a7b"
    objects: |
      array:
        - |
          objectName: GH-APP-PRIVATE-KEY-BASE64
          objectType: secret
        - |
          objectName: GH-OAUTH-CLIENT-SECRET
          objectType: secret
        - |
          objectName: GITHUB-WEBHOOK-SECRET
          objectType: secret
        - |
          objectName: ELASTICSEARCH-API-KEY
          objectType: secret
        - |
          objectName: rabbitmq-url
          objectType: secret
        - |
          objectName: app-config-endpoint
          objectType: secret
  secretObjects:
    - secretName: backend-secrets
      type: Opaque
      data:
        - objectName: GH-APP-PRIVATE-KEY-BASE64
          key: GH_APP_PRIVATE_KEY_BASE64
        - objectName: GH-OAUTH-CLIENT-SECRET
          key: GH_OAUTH_CLIENT_SECRET
        - objectName: GITHUB-WEBHOOK-SECRET
          key: GITHUB_WEBHOOK_SECRET
        - objectName: ELASTICSEARCH-API-KEY
          key: ELASTICSEARCH_API_KEY
        - objectName: rabbitmq-url
          key: RABBITMQ_URL
        - objectName: app-config-endpoint
          key: AZURE_APP_CONFIG_ENDPOINT
